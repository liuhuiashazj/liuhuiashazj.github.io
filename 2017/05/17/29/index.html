<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>electron在企业云盘中的应用 | 享受阳光生活</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简要介绍 Electron是一个可以使用js、html、css创建桌面应用的库 可以创建mac、window、linux等应用 atom基于electron开发，以前叫atom-shell">
<meta property="og:type" content="article">
<meta property="og:title" content="electron在企业云盘中的应用">
<meta property="og:url" content="http://yoursite.com/2017/05/17/29/index.html">
<meta property="og:site_name" content="享受阳光生活">
<meta property="og:description" content="简要介绍 Electron是一个可以使用js、html、css创建桌面应用的库 可以创建mac、window、linux等应用 atom基于electron开发，以前叫atom-shell">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/6.1.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.md0uZGp9DO.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.mdFssiOOjv.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.mdI503ErtM.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.mdVNSa2xBo.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.mdjmQL57oN.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.mdc16yuk4H.png">
<meta property="og:image" content="http://yoursite.com/images/test/28.mdEjTOVah6.png">
<meta property="og:updated_time" content="2017-10-20T07:39:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="electron在企业云盘中的应用">
<meta name="twitter:description" content="简要介绍 Electron是一个可以使用js、html、css创建桌面应用的库 可以创建mac、window、linux等应用 atom基于electron开发，以前叫atom-shell">
<meta name="twitter:image" content="http://yoursite.com/images/6.1.png">
  
    <link rel="alternate" href="/atom.xml" title="享受阳光生活" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">享受阳光生活</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">珍惜拥有，坚持不懈，努力奋斗！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-29" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/17/29/" class="article-date">
  <time datetime="2017-05-17T08:39:45.000Z" itemprop="datePublished">2017-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      electron在企业云盘中的应用
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="简要介绍"><a href="#简要介绍" class="headerlink" title="简要介绍"></a>简要介绍</h4><ul>
<li>Electron是一个可以使用js、html、css创建桌面应用的库</li>
<li>可以创建mac、window、linux等应用</li>
<li>atom基于electron开发，以前叫atom-shell<a id="more"></a>
<img src="/images/6.1.png" alt="img"></li>
</ul>
<h4 id="如何开发你的desktop应用"><a href="#如何开发你的desktop应用" class="headerlink" title="如何开发你的desktop应用"></a>如何开发你的desktop应用</h4><ul>
<li>一个简单的 demo<br><a href="https://github.com/sindresorhus/electron-boilerplate/tree/master/boilerplate" target="_blank" rel="external">demo</a></li>
<li>一个入口main.js（mainProcess）+ 一个index.html（renderProcess）</li>
<li>执行 electron main.js<br>企业云盘的整体结构</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">├── build(app打包资源)</div><div class="line">├── readme.md</div><div class="line">├── release(发布路径)</div><div class="line">├── renderProcess（渲染进程）</div><div class="line">├── mainProcess（主进程）</div><div class="line">├── plugin(插件)</div><div class="line">├── certs(证书)</div><div class="line">├── build.sh(自动发版脚本)</div><div class="line">├── config.js(全局配置项)</div><div class="line">├── package.json</div><div class="line">└── windowinstall.js（window安装包生成脚本）</div></pre></td></tr></table></figure>
<ul>
<li>整体的结构就是按照两个进程来划分</li>
<li>renderProcess中可以使用任何你想用的架构，企业云盘采用的是react+redux+router结构</li>
<li>企业云盘开发环境中采用localhost:3000的实时编译调试模式，发包时采用file协议</li>
</ul>
<h4 id="mainProces"><a href="#mainProces" class="headerlink" title="mainProces:"></a>mainProces:</h4><h5 id="数据库采用nodejs库-nedb-mainProcess-database"><a href="#数据库采用nodejs库-nedb-mainProcess-database" class="headerlink" title="数据库采用nodejs库 nedb(mainProcess/database)"></a>数据库采用nodejs库 nedb(mainProcess/database)</h5><p>数据文件存储在应用数据下的.clouddiskdata，刚开始采用的是mongodb,后来打包发现太大，多40多M，还卡</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> Datastore = <span class="built_in">require</span>(<span class="string">'nedb'</span>);</div><div class="line"><span class="keyword">let</span> db = <span class="keyword">new</span> Datastore(&#123; <span class="attr">filename</span>: <span class="string">'path/to/datafile'</span> &#125;);</div><div class="line">db.loadDatabase(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;    <span class="comment">// Callback is optional</span></div><div class="line">  <span class="comment">// Now commands will be executed</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意nedb为了保证数据的持久性，每一次update或者delete操作实际上都是在最后一行添加一条数据，但是每次load database的时候，会自动合并所有的数据项，所以云盘里面可以看到每次update都调用了<br>db.loadDatabase();</p>
<p>官方解释如下：</p>
<p>Under the hood, NeDB’s persistence uses an append-only format, meaning that all updates and deletes actually result in lines added at the end of the datafile, for performance reasons. The database is automatically compacted (i.e. put back in the one-line-per-document format) every time you load each database within your application.</p>
<p><a href="https://github.com/louischatriot/nedb" target="_blank" rel="external">官网</a></p>
<h5 id="登录认证-mainProcess-uuap"><a href="#登录认证-mainProcess-uuap" class="headerlink" title="登录认证 (mainProcess/uuap)"></a>登录认证 (mainProcess/uuap)</h5><p>浏览器向server发起请求,server端进行登录，并且在head中set-cookie</p>
<p>mainProcess通过该有效cookie发起后续所有请求</p>
<p>renderProcess中的请求通过ipc通信方式使用nodejs的request模块来进行通信</p>
<h5 id="浏览器中直接调起客户端，urlScheme-mainProcess-urlProtocol"><a href="#浏览器中直接调起客户端，urlScheme-mainProcess-urlProtocol" class="headerlink" title="浏览器中直接调起客户端，urlScheme(mainProcess/urlProtocol)"></a>浏览器中直接调起客户端，urlScheme(mainProcess/urlProtocol)</h5><p>1.浏览器端</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"ecloud-baidu://open"</span>&gt;</span>添加备份<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure>
<p>2.mainProcess代码如下<br><img src="/images/test/28.md0uZGp9DO.png" alt="img"></p>
<p>3.配置info.plist<br><img src="/images/test/28.mdFssiOOjv.png" alt="img"></p>
<p>4.打包过程中也需要配置下，否则mac中不生效<br><img src="/images/test/28.mdI503ErtM.png" alt="img"></p>
<h5 id="窗口管理器（mainProcess-windowManage）"><a href="#窗口管理器（mainProcess-windowManage）" class="headerlink" title="窗口管理器（mainProcess/windowManage）"></a>窗口管理器（mainProcess/windowManage）</h5><p>1.企业云盘总共有三个window（主页、设置页、预览页、反馈页、二次确认页）   </p>
<h5 id="traymenu控制（mainProcess-trayMenu）"><a href="#traymenu控制（mainProcess-trayMenu）" class="headerlink" title="traymenu控制（mainProcess/trayMenu）"></a>traymenu控制（mainProcess/trayMenu）</h5><p>参考官方api写即可，大致代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> contextMenu = Menu.buildFromTemplate([</div><div class="line">    &#123;</div><div class="line">        label: <span class="string">'访问网页版'</span>,</div><div class="line">        click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            shell.openExternal(<span class="string">'http://ecloud.baidu.com'</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;, &#123;</div><div class="line">        label: <span class="string">'反馈'</span>,</div><div class="line">        click: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">            renderFeedBack(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;, &#123;</div><div class="line">        label: <span class="string">'设置'</span>,</div><div class="line">        click: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">            renderSettingWindow(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;, &#123;</div><div class="line">        label: <span class="string">'退出'</span>,</div><div class="line">        click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            app.quit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">])</div></pre></td></tr></table></figure>
<p><img src="/images/test/28.mdVNSa2xBo.png" alt="img"></p>
<h5 id="传输控制（mainProcess-transfile-、-mainProcess-watcher）"><a href="#传输控制（mainProcess-transfile-、-mainProcess-watcher）" class="headerlink" title="传输控制（mainProcess/transfile 、 mainProcess/watcher）"></a>传输控制（mainProcess/transfile 、 mainProcess/watcher）</h5><p>本地文件增删改查检测（使用nodejs库chokidar，目前mac已迁移到Object-c的app中）</p>
<p>关于electron中与oc app的通信方式。目前采用的是shell里面的open命令，以及web server方式<br>mainProcess中创建webserver服务，oc中通过发起http请求进行通信<br>mainProcess和oc通信采用open方式</p>
<p>云盘接受oc的web服务</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123; </div><div class="line">        <span class="comment">//.....</span></div><div class="line">        <span class="comment">/*前端需要备份的文件*/</span></div><div class="line">        <span class="keyword">if</span> (urlObj.pathname === <span class="string">'/set/file'</span>) &#123;</div><div class="line">            response.end(<span class="string">'end'</span>);</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        <span class="comment">/*获取我的备份下需要备份的根目录或者文件*/</span></div><div class="line">        <span class="keyword">if</span> (urlObj.pathname === <span class="string">'/get/rootpath'</span>) &#123;</div><div class="line">        &#125;</div><div class="line">&#125;).listen(<span class="number">8887</span>);</div><div class="line">        <span class="comment">//.......</span></div></pre></td></tr></table></figure>
<p>打开oc应用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> execSync = <span class="built_in">require</span>(<span class="string">'child_process'</span>).execSync;</div><div class="line">execSync(<span class="string">'open ecloud-sync-backup-file.app'</span>, &#123;</div><div class="line">    cwd: <span class="string">`<span class="subst">$&#123;config.projectPath&#125;</span>/mainProcess/watcher/OC/ecloud-sync-backup-file`</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>md5计算，采用md5-file</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> md5File = <span class="built_in">require</span>(<span class="string">'md5-file'</span>);</div><div class="line">md5File(filePath, (err, hash2) =&gt; &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>分片：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fs.createReadStream(filePath, &#123;</div><div class="line">    start : i * limit,</div><div class="line">    end   : (i * limit + limit - <span class="number">1</span>) &gt; lastByte? lastByte: i * limit + limit - <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="系统通知："><a href="#系统通知：" class="headerlink" title="系统通知："></a>系统通知：</h5><p>mac采用 notification<br>window采用nodejs的node-notifier模块</p>
<h5 id="自动更新客户端（mainProcess-checkUpdate）"><a href="#自动更新客户端（mainProcess-checkUpdate）" class="headerlink" title="自动更新客户端（mainProcess/checkUpdate）"></a>自动更新客户端（mainProcess/checkUpdate）</h5><p><a href="https://electron.atom.io/docs/api/auto-updater/" target="_blank" rel="external">官方文档</a></p>
<p>官方提供了几个自动更新的项目，nuts/electron-release-server/squirrel-updates-server/squirrel-release-server,这几个项目中其中2个都是采用github来进行发布，不符合我国国情</p>
<p>企业云采用了electron-release-server这个项目来搭建自动升级服务</p>
<ul>
<li><p>基于docker-compose</p>
<ul>
<li>中间遇到的坑，这个项目基于docker-composer 的version2 版本，最低要求docker的版本为1.9.1以上，具体可参考 <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#args" target="_blank" rel="external">https://docs.docker.com/compose/compose-file/compose-file-v2/#args</a></li>
<li>最后采用了ubuntu的服务器，centos版本都太低</li>
<li>开源项目里面需要简单的配置下数据库、服务器、修改资源存储的路径为永久存储</li>
<li>公司的服务器的端口必须是8000以上，刚开始设置了个5555 怎么都不好使，能ping通，但是浏览器没法访问</li>
</ul>
</li>
<li>包含了资源存储</li>
<li>强大的api支持</li>
<li><p>使用Squirrel来模块来完成自动升级</p>
<ul>
<li>mac使用.dmg和.zip</li>
<li>window 使用.exe .nupkg<br>关于自动更新中必须要注意的几个点：</li>
</ul>
<ul>
<li><p>必须要有证书</p>
<ul>
<li>mac通过开发者账号生成,公司苹果开发者团队，可以通过权限申请加入，地址：<a href="http://appdev.baidu.com/" target="_blank" rel="external">http://appdev.baidu.com/</a></li>
</ul>
</li>
<li><p>window证书<br>ecloud.pfx,带秘钥的证书，具体可以参考 如何生成pfx的证书<br>具体方案可以参考 Auto-updating apps for Windows and OSX using Electron: The complete guide</p>
</li>
</ul>
</li>
</ul>
<p>自动更新提示如下<br><img src="/images/test/28.mdjmQL57oN.png" alt="img"><br><img src="/images/test/28.mdc16yuk4H.png" alt="img"></p>
<ul>
<li>遇到坑<br>mac中autoUpdater.quitAndInstall(); 没有自动重启应用<br>可以通过<br>/Users/liuhui/Library/Caches/com.electron.ecloud.ShipIt下的<br>ShipIt_stderr.log来查看问题所在</li>
</ul>
<p>window中采用squirrel安装方式后很多问题，安装过程中应用就被打开，需要处理下squirrel事件,可以参考 <a href="https://github.com/electron/windows-installer" target="_blank" rel="external">https://github.com/electron/windows-installer</a></p>
<h4 id="flash的支持"><a href="#flash的支持" class="headerlink" title="flash的支持"></a>flash的支持</h4><p>需要添加pepper flash插件，Pepper Flash Player 是由Google维护的专用于chromium引擎的flash播放器</p>
<p>首先是在自己电脑上找到pepper flash的插件（mac及window版本）</p>
<p>结果如下：</p>
<ul>
<li>如果你有安装Chrome浏览器，可以在地址栏输入chrome://plugins/，点击右侧的详细信息，找到Adobe Flash Player条目,目前chrome已经废弃掉chrome://plugins/地址</li>
<li>实际mac地址：/Library/Internet Plug-Ins/PepperFlashPlayer/PepperFlashPlayer.plugin<br>window地址：C:\Windows\System32\Macromed\Flash\pepflashplayer64_24_0_0_194.dll(名称和版本号可能有出入) 重命名为pepflashplayer.dll即可。</li>
</ul>
<p>中间遇到的坑：</p>
<ul>
<li>window上不好使，提示“无法加载插件”，确定为pepflashplayer64_24_0_0_194.dll的问题，去网上下载了一个</li>
<li>chrome 53里面的flash有个闪烁的bug，浏览器bug，需要升级chrome版本<br>pepper flash引入<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> pluginName;</div><div class="line"><span class="keyword">switch</span> (process.platform) &#123;</div><div class="line">  <span class="keyword">case</span> <span class="string">'win32'</span>:</div><div class="line">    pluginName = <span class="string">'pepflashplayer.dll'</span></div><div class="line">    <span class="keyword">break</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'darwin'</span>:</div><div class="line">    pluginName = <span class="string">'PepperFlashPlayer.plugin'</span></div><div class="line">    <span class="keyword">break</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'linux'</span>:</div><div class="line">    pluginName = <span class="string">'libpepflashplayer.so'</span></div><div class="line">    <span class="keyword">break</span></div><div class="line">&#125;</div><div class="line">app.commandLine.appendSwitch(<span class="string">'ppapi-flash-path'</span>, path.join(__dirname+<span class="string">'/plugins/'</span>, pluginName))</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="网络检测-mainProcess-network"><a href="#网络检测-mainProcess-network" class="headerlink" title="网络检测(mainProcess/network)"></a>网络检测(mainProcess/network)</h4><p>网络监测刚开始采用的 <a href="https://developer.mozilla.org/en-US/docs/Online_and_offline_events" target="_blank" rel="external">https://developer.mozilla.org/en-US/docs/Online_and_offline_events</a><br>监测很准确，这种检测仅仅针对lan是否有连接，实际情况是很多时候网络是连着的，但是不能上网<br>后面换成nodejs的方案</p>
<h5 id="renderProcess"><a href="#renderProcess" class="headerlink" title="renderProcess"></a>renderProcess</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">├── bin</div><div class="line">│   ├── compile.js</div><div class="line">│   └── server.js</div><div class="line">├── build</div><div class="line">│   ├── dll</div><div class="line">│   ├── package.json</div><div class="line">│   ├── webpack-compiler.js</div><div class="line">│   ├── webpack.config.js</div><div class="line">│   └── webpack.dll.config.js</div><div class="line">├── config</div><div class="line">│   └── index.js</div><div class="line">├── package.json</div><div class="line">├── server</div><div class="line">│   └── main.js</div><div class="line">└── src</div><div class="line">    ├── components 组件</div><div class="line">    ├── containers 容器</div><div class="line">    ├── index.html 入口html</div><div class="line">    ├── ipcCenter.js 消息中心</div><div class="line">    ├── layouts 布局</div><div class="line">    ├── main.js 入口js</div><div class="line">    ├── routes 路由</div><div class="line">    ├── static 静态js</div><div class="line">    ├── statichtml 其他入口html</div><div class="line">    ├── store 通用的store</div><div class="line">    └── styles 样式</div></pre></td></tr></table></figure>
<h5 id="两个进程"><a href="#两个进程" class="headerlink" title="两个进程"></a>两个进程</h5><p><a href="https://electron.atom.io/docs/" target="_blank" rel="external">官方网站</a></p>
<ul>
<li>electron合并了chromium和node.js</li>
<li>提供了一系列的api进行native开发，例如file dialogs,notifications,icons更多</li>
</ul>
<p>中间的坑：</p>
<ul>
<li><p>可以看到官方网站提供了mainProcess和renderProcess区分了接口，但是这两个api并不是完全独立的，renderProces提供的remote模块可以获取到mainProcess到所有的api，详细见接口 接口文档<br>企业云盘在mainProcess里面定义了整个app通用的全局变量：</p>
</li>
<li><p>虽然renderProcess中可以访问到mainProcess里面的全局变量，但是renderProcess里面修改并不会影响到mainPorcess里面的变量</p>
</li>
</ul>
<h4 id="打包方式"><a href="#打包方式" class="headerlink" title="打包方式"></a>打包方式</h4><p>打包方式，企业云盘用过2种</p>
<ul>
<li><p>electron-package</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">"build": "electron-packager ./ clouddisk --platform=darwin,win32 --arch=x64 --prune --overwrite --version=1.4.13 --ignore renderProcess/node_modules --icon ./icon",</div><div class="line">"buildwin": "electron-packager ./ clouddisk --platform=win32 --arch=x64 --prune --overwrite --version=1.4.13 --ignore renderProcess/node_modules --icon ./icon",</div><div class="line">"buildmac": "electron-packager ./ clouddisk --platform=darwin --arch=x64 --prune --overwrite --version=1.4.3 --ignore renderProcess/node_modules --icon ./icon",</div></pre></td></tr></table></figure>
</li>
<li><p>electron-builder</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">"build": &#123;</div><div class="line">    "appId": "com.electron.ecloud",</div><div class="line">    "productName": "ecloud",</div><div class="line">    "mac": &#123;</div><div class="line">      "extendInfo": "build/info.plist"</div><div class="line">    &#125;,</div><div class="line">    // ...</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这两种打包方式的区别：<br>electron-package 仅能打出应用程序，无法打出安装包，配置项没有electron-builder那么灵活</p>
<p>electron-builder 支持非常强大的配置，可以参考 官网</p>
<p>需要注意的是自动更新需要打出nupkg的包，electron-builder也是支持的</p>
<p><img src="/images/test/28.mdEjTOVah6.png" alt="img"></p>
<p>自动更新依赖于squirrel模块，这个模块决定了window的打包方式必须是squirrel的安装包，从而决定了不一样的window安装包（nsis或者squirrel）</p>
<p>squirrel安装包依赖于net 4.5</p>
<h4 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h4><ul>
<li><p>抓包<br>企业云盘里面所有的请求都基于node的request模块，所以给request设置下代理即可，如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 只能代理到http</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'./mainProcess/request'</span>).defaults(&#123; <span class="attr">proxy</span>: <span class="string">'http://127.0.0.1:8888'</span> &#125;) </div><div class="line"><span class="comment">// https如下</span></div><div class="line"><span class="keyword">let</span> useProxy=<span class="number">1</span>;</div><div class="line"><span class="keyword">if</span>(useProxy)&#123;</div><div class="line">    process.env.https_proxy = <span class="string">"http://127.0.0.1:8888"</span>;</div><div class="line">    process.env.http_proxy = <span class="string">"http://127.0.0.1:8888"</span>;</div><div class="line">    process.env.NODE_TLS_REJECT_UNAUTHORIZED = <span class="string">"0"</span>;</div><div class="line">&#125;</div><div class="line"><span class="string">``</span><span class="string">` </span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">- 调试renderProcess 打开browser window的控制台</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">`</span><span class="string">``</span> js</div><div class="line">/localhost/.test(appUrl) &amp;&amp; win.webContents.openDevTools();</div></pre></td></tr></table></figure>
</li>
<li><p>调试mainProcess<br>console.log直接会在terminal中打出，另外全局有写一个小工具debugInRender,这个工具会将mainProcess的调试信息打印在renderProcess的控制台中</p>
</li>
<li><p>调试用户的电脑<br>企业云盘-显示包内容-contents-resources-app里面，修改代码重启可生效，<br>当然云盘在打包的时候可以压缩所有代码为asar格式的，只需要在package的配置中添加</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">"asar": true</div></pre></td></tr></table></figure>
<p>mac中crash情况debugger<br><a href="https://electron.atom.io/docs/development/debugging-instructions-macos/" target="_blank" rel="external">https://electron.atom.io/docs/development/debugging-instructions-macos/</a></p>
<p>官方给出的调试方案<br><a href="https://github.com/electron/electron/blob/master/docs/tutorial/debugging-main-process.md" target="_blank" rel="external">https://github.com/electron/electron/blob/master/docs/tutorial/debugging-main-process.md</a></p>
<p>使用visual studio code进行调试<br>详细参考 <a href="https://www.youtube.com/watch?v=nuZIeJ0ljgo" target="_blank" rel="external">https://www.youtube.com/watch?v=nuZIeJ0ljgo</a><br>具体的launch.json配置如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">"program": "$&#123;workspaceRoot&#125;/main.js",</div><div class="line">"runtimeExecutable":"/Users/liuhui/.tnvm/versions/node/v6.6.0/bin/electron",</div><div class="line">"runtimeArgs":[</div><div class="line">    <span class="string">"-enable-logging"</span></div><div class="line">],</div><div class="line">"env":&#123;</div><div class="line">    "NODE_ENV": "development",</div><div class="line">    "DEBUG": "app:*"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://nulab-inc.com/blog/typetalk/3-necessary-things-to-correctly-release-a-product-based-on-the-electron-app/" target="_blank" rel="external">electron 文章</a></p>
<p><a href="https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md" target="_blank" rel="external">electron和nw区别</a></p>
<p>相关资源</p>
<p><a href="https://electron.atom.io/docs/" target="_blank" rel="external">https://electron.atom.io/docs/</a><br><a href="https://github.com/electron-userland/electron-builder" target="_blank" rel="external">https://github.com/electron-userland/electron-builder</a><br><a href="https://github.com/electron/windows-installer" target="_blank" rel="external">https://github.com/electron/windows-installer</a><br><a href="https://github.com/ArekSredzki/electron-release-server" target="_blank" rel="external">https://github.com/ArekSredzki/electron-release-server</a><br><a href="https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md" target="_blank" rel="external">https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md</a><br><a href="https://medium.com/developers-writing/building-a-desktop-application-with-electron-204203eeb658" target="_blank" rel="external">https://medium.com/developers-writing/building-a-desktop-application-with-electron-204203eeb658</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/05/17/29/" data-id="cj8zk8frf000ocsxl2010m150" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/05/23/30/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          nodejs 与javascript 关系
        
      </div>
    </a>
  
  
    <a href="/2017/05/11/28/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">node request请求如何抓包+js正则+htmlCollection</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/资源/">资源</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/资源/" style="font-size: 10px;">资源</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/21/5/">(译文)如何实现virtual dom</a>
          </li>
        
          <li>
            <a href="/2017/09/15/3/">node里面NODE_ENV有什么用</a>
          </li>
        
          <li>
            <a href="/2017/09/14/1/">资源检索</a>
          </li>
        
          <li>
            <a href="/2017/09/14/2/">提高工作效率的cli工具</a>
          </li>
        
          <li>
            <a href="/2017/07/24/35/">(翻译)Nodejs EventLoop&amp;Timers&amp;process.netxTick()</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Babel<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>